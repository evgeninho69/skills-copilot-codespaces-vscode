<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ЕЭКО на Flask</title>
    <!-- Сначала подключаем все необходимые библиотеки -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.min.js"></script>
    <!-- Добавляем jQuery и jQuery UI для надежного перетаскивания -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <!-- Добавляем Leaflet.Draw для рисования полигонов -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif; 
            overflow: hidden; /* Предотвращаем прокрутку */
            height: 100vh;
            width: 100vw;
        }
        
        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0;
            resize: none;
            overflow: hidden;
        }

        #map { 
            height: 100%;
            width: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        h1 {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            margin: 0;
            padding: 5px 15px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 5px;
            font-size: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .leaflet-control-layers {
            font-family: Arial, sans-serif;
            font-size: 14px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: none;
        }
        .leaflet-control-layers-toggle {
            width: 40px;
            height: 40px;
            background-size: 20px 20px;
            border-radius: 4px;
            background-color: white;
            transition: all 0.3s ease;
        }
        .leaflet-control-layers-toggle:hover {
            background-color: #f4f4f4;
        }
        .leaflet-control-layers-list {
            padding: 6px;
        }
        .leaflet-control-layers label {
            margin-bottom: 5px;
        }
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .leaflet-control-zoom-in,
        .leaflet-control-zoom-out {
            width: 40px !important;
            height: 40px !important;
            line-height: 40px !important;
            border-radius: 4px !important;
            background-color: white !important;
            color: #333 !important;
            font-size: 18px !important;
            transition: all 0.3s ease;
        }
        .leaflet-control-zoom-in:hover,
        .leaflet-control-zoom-out:hover {
            background-color: #f4f4f4 !important;
            color: #000 !important;
        }
        .leaflet-control-scale {
            font-family: Arial, sans-serif;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .coordinate-display {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        .search-control.leaflet-control {
            margin-right: 10px;
            margin-top: 50px;
        }

        .search-button {
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .search-button:hover {
            background-color: #f4f4f4;
            transform: scale(1.05);
        }

        .search-container {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
            width: 300px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .search-container.active {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-bottom: 1px solid #eee;
            border-radius: 4px 4px 0 0;
            font-size: 14px;
            box-sizing: border-box;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-bottom-color: #0078A8;
            box-shadow: 0 1px 0 0 #0078A8;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #0078A8 #f4f4f4;
        }

        .search-results::-webkit-scrollbar {
            width: 6px;
        }

        .search-results::-webkit-scrollbar-track {
            background: #f4f4f4;
        }

        .search-results::-webkit-scrollbar-thumb {
            background-color: #0078A8;
            border-radius: 3px;
        }

        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: all 0.2s ease;
            font-size: 13px;
            color: #333;
        }

        .search-result-item:hover {
            background: #f8f8f8;
            padding-left: 15px;
        }

        .search-result-item:last-child {
            border-bottom: none;
            border-radius: 0 0 4px 4px;
        }

        /* Убираем стили для ресайзинга, так как карта теперь на весь экран */
        .map-container::after {
            content: none;
        }

        /* Кнопка выхода из полноэкранного режима */
        .fullscreen-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: none;
            border-radius: 4px;
            width: 40px;
            height: 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Стили для поиска кадастровых объектов */
        .cadastral-search {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 5px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .cadastral-search input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
            font-size: 14px;
        }
        
        .cadastral-search button {
            padding: 8px 15px;
            background: #0078A8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .cadastral-search button:hover {
            background: #005b80;
        }

        /* Стили для кадастровых объектов */
        .cadastral-tooltip {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .cadastral-popup {
            max-width: 350px;
            max-height: 400px;
        }

        .cadastral-popup-content {
            font-size: 13px;
            overflow-y: auto;
            max-height: 300px;
        }

        .cadastral-popup-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #0078A8;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .cadastral-popup-row {
            display: flex;
            margin-bottom: 5px;
        }

        .cadastral-popup-label {
            font-weight: bold;
            min-width: 140px;
            color: #555;
        }

        .cadastral-popup-value {
            flex: 1;
        }

        /* Стили для подписи кадастрового номера на участке */
        .cadastral-label {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid #000;
            padding: 2px 4px;
            font-size: 11px;
            font-weight: bold;
            color: #000;
            text-align: center;
            border-radius: 3px;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* Удаляем стили для кнопок работы с контурами */
        .cadastral-tools {
            position: absolute;
            top: 110px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            padding: 5px;
        }

        .cadastral-tools button {
            display: block;
            width: 100%;
            padding: 8px 10px;
            margin-bottom: 5px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-size: 13px;
        }

        .cadastral-tools button:last-child {
            margin-bottom: 0;
        }

        .cadastral-tools button:hover {
            background: #f4f4f4;
            border-color: #bbb;
        }

        .cadastral-tools button.active {
            background: #e6f2f7;
            border-color: #0078A8;
            color: #0078A8;
        }

        /* Стили для отображения состояния загрузки */
        .loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 5px;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            display: none;
            text-align: center;
        }

        .loading-indicator .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0078A8;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Стили для отдельного контрола кадастровых слоев */
        .cadastral-layers-control {
            position: absolute;
            top: 10px;
            right: 50px;
            z-index: 1000;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            padding: 10px;
            width: 280px;
            font-size: 14px;
            cursor: move; /* Указатель при наведении */
            transition: box-shadow 0.2s ease;
        }
        
        /* Стиль для панели во время перетаскивания */
        .cadastral-layers-control.dragging {
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            opacity: 0.9;
            z-index: 1100; /* Увеличиваем z-index во время перетаскивания */
        }

        .cadastral-layers-title {
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            color: #333;
            cursor: move; /* Указатель при наведении на заголовок */
            position: relative;
            padding: 5px;
            margin: -5px -5px 8px -5px;
            user-select: none; /* Запрещаем выделение текста */
        }
        
        /* Эффект наведения на заголовок */
        .cadastral-layers-title:hover {
            background-color: #f9f9f9;
            border-radius: 4px 4px 0 0;
        }
        
        /* Визуальный эффект при активном заголовке (нажатии) */
        .cadastral-layers-title:active {
            background-color: #f5f5f5;
            cursor: grabbing;
        }

        .cadastral-layer-item {
            margin-bottom: 6px;
            display: flex;
            align-items: center;
        }

        .cadastral-layer-item input {
            margin-right: 8px;
        }

        .cadastral-layer-item label {
            cursor: pointer;
            flex: 1;
        }

        /* Стили для списка перекрывающихся объектов */
        .overlapping-objects-popup {
            position: absolute;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            padding: 10px;
            min-width: 250px;
        }

        .overlapping-objects-title {
            font-weight: bold;
            padding-bottom: 8px;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            color: #0078A8;
        }

        .overlapping-object-item {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: all 0.2s ease;
        }

        .overlapping-object-item:hover {
            background: #f0f8ff;
            padding-left: 15px;
        }

        .overlapping-object-cadnum {
            font-weight: bold;
        }

        .overlapping-object-type {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        .overlapping-object-highlight {
            animation: pulse-highlight 1.5s ease-in-out infinite;
        }

        @keyframes pulse-highlight {
            0% { opacity: 0.8; }
            50% { opacity: 0.4; }
            100% { opacity: 0.8; }
        }
    </style>
</head>
<body>
    <div class="map-container">
    <h1>Единая электронная картографическая основа</h1>
    
        <!-- Форма для поиска кадастровых объектов -->
        <div class="cadastral-search">
            <input type="text" id="cadastral-input" placeholder="Введите кадастровый номер..." />
            <button id="cadastral-search-btn">Найти объект</button>
    </div>
        
        <!-- Добавляем инструменты для работы с контурами -->
        <div class="cadastral-tools">
            <button id="draw-polygon-btn" title="Выделите область на карте, чтобы найти кадастровые объекты">Поиск по области</button>
            <button id="clear-polygon-btn" title="Очистить все выделенные области">Очистить области</button>
        </div>
        
        <!-- Индикатор загрузки -->
        <div class="loading-indicator">
            <div class="spinner"></div>
            <div>Загрузка объектов...</div>
        </div>

        <div id="map"></div>
    <div id="coordinate-display" class="coordinate-display"></div>
    </div>

    <script>
        // Заменим определение систем координат на одну стандартную
        const mapCrs = L.CRS.EPSG3857; // Web Mercator

        // Добавим информацию о системе координат
        const crsInfo = {
            name: 'Web Mercator (EPSG:3857)',
            description: 'Проекция Меркатора, используемая в веб-картографии',
            params: {
                datum: 'WGS 84',
                proj: '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs',
                bounds: [-20026376.39, -20048966.10, 20026376.39, 20048966.10],
                units: 'метры'
            }
        };

        // Обновим информацию о системах координат
        const layersCrsInfo = {
            "OpenStreetMap": {
                name: 'EPSG:3857',
                description: 'Web Mercator (Сферическая проекция Меркатора)',
                details: {
                    datum: 'WGS 84',
                    proj: '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs',
                    bounds: [-20026376.39, -20048966.10, 20026376.39, 20048966.10],
                    units: 'метры',
                    usage: `
                        <strong>Применение:</strong><br>
                        • Веб-картография<br>
                        • Онлайн-карты<br>
                        • Навигационные системы<br><br>
                        <strong>Особенности:</strong><br>
                        • Конформная проекция (сохраняет углы)<br>
                        • Искажает площади, особенно в высоких широтах<br>
                        • Экватор является стандартной параллелью<br>
                        • Масштаб постоянен вдоль меридианов<br><br>
                        <strong>Параметры проекции:</strong><br>
                        • Большая полуось (a): 6378137.0 м<br>
                        • Малая полуось (b): 6378137.0 м<br>
                        • Масштабный коэффициент (k): 1.0<br>
                        • Начало координат: 0° ш., 0° д.<br><br>
                        <strong>Преобразование координат:</strong><br>
                        1. Географические → Проекционные:<br>
                        x = R × λ<br>
                        y = R × ln[tan(π/4 + φ/2)]<br>
                        где R = 6378137 м, λ - долгота в радианах, φ - широта в радианах<br><br>
                        2. Проекционные → Географические:<br>
                        λ = x/R<br>
                        φ = 2 × atan(e^(y/R)) - π/2<br><br>
                        <strong>Ограничения:</strong><br>
                        • Широта: от -85.06° до +85.06°<br>
                        • Долгота: от -180° до +180°<br><br>
                        <strong>Практическое применение:</strong><br>
                        • Для веб-карт используйте готовые тайлы<br>
                        • Для GIS-анализа учитывайте искажения площадей<br>
                        • Для навигации используйте формулы пересчета
                    `
                }
            },
            "Google Спутник": {
                name: 'EPSG:3857',
                description: 'Web Mercator (Google Maps)',
                details: {
                    datum: 'WGS 84',
                    proj: '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs',
                    bounds: [-20026376.39, -20048966.10, 20026376.39, 20048966.10],
                    units: 'метры',
                    usage: `
                        <strong>Особенности слоя:</strong><br>
                        • Спутниковые снимки высокого разрешения<br>
                        • Регулярное обновление данных<br>
                        • Глобальное покрытие<br><br>
                        <strong>Система координат:</strong><br>
                        • Идентична OSM (EPSG:3857)<br>
                        • Оптимизирована для веб-карт<br>
                        • Поддерживает тайловую структуру<br><br>
                        <strong>Точность и разрешение:</strong><br>
                        • Максимальное разрешение: до 0.1 м/пиксель<br>
                        • Точность позиционирования: 1-5 м<br>
                        • Обновление: варьируется по регионам<br><br>
                        <strong>Использование в ГИС:</strong><br>
                        • Подходит для визуализации и оцифровки<br>
                        • Поддерживает оверлеи и векторные слои<br>
                        • Интегрируется с другими форматами данных
                    `
                }
            },
            "Google Гибрид": {
                name: 'EPSG:3857',
                description: 'Web Mercator (Google Maps Hybrid)',
                details: {
                    datum: 'WGS 84',
                    proj: '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs',
                    bounds: [-20026376.39, -20048966.10, 20026376.39, 20048966.10],
                    units: 'метры',
                    usage: `
                        <strong>Особенности гибридного слоя:</strong><br>
                        • Комбинация спутниковых снимков и векторных данных<br>
                        • Автоматическая генерализация подписей<br>
                        • Динамическая загрузка данных<br><br>
                        <strong>Применение:</strong><br>
                        • Навигация и ориентирование<br>
                        • Градостроительный анализ<br>
                        • Кадастровые работы<br><br>
                        <strong>Преимущества:</strong><br>
                        • Сочетание детальности снимков и информативности карты<br>
                        • Улучшенная читаемость в городской среде<br>
                        • Актуальность данных
                    `
                }
            },
            "Яндекс": {
                name: 'EPSG:3857',
                description: 'Web Mercator (Яндекс.Карты)',
                details: {
                    datum: 'WGS 84',
                    proj: '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs',
                    bounds: [-20026376.39, -20048966.10, 20026376.39, 20048966.10],
                    units: 'метры',
                    usage: `
                        <strong>Особенности Яндекс.Карт:</strong><br>
                        • Детальное покрытие России и СНГ<br>
                        • Оптимизация для локального использования<br>
                        • Регулярные обновления<br><br>
                        <strong>Система координат:</strong><br>
                        • Стандартная Web Mercator<br>
                        • Поддержка локальных систем координат<br>
                        • Совместимость с международными стандартами<br><br>
                        <strong>Практическое применение:</strong><br>
                        • Геокодирование адресов<br>
                        • Маршрутизация<br>
                        • Пространственный анализ
                    `
                }
            },
            "Яндекс Спутник": {
                name: 'EPSG:3857',
                description: 'Web Mercator (Яндекс.Спутник)',
                details: {
                    datum: 'WGS 84',
                    proj: '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs',
                    bounds: [-20026376.39, -20048966.10, 20026376.39, 20048966.10],
                    units: 'метры',
                    usage: `
                        <strong>Особенности спутникового слоя:</strong><br>
                        • Высокое разрешение для территории РФ<br>
                        • Регулярное обновление снимков<br>
                        • Оптимизация для российских условий<br><br>
                        <strong>Технические характеристики:</strong><br>
                        • Разрешение до 0.5 м/пиксель в крупных городах<br>
                        • Многоуровневая система кэширования<br>
                        • Адаптивная генерализация изображений<br><br>
                        <strong>Применение:</strong><br>
                        • Мониторинг территорий<br>
                        • Градостроительный анализ<br>
                        • Экологический контроль<br><br>
                        <strong>Особенности использования:</strong><br>
                        • Поддержка оффлайн-кэширования<br>
                        • Интеграция с геоинформационными системами<br>
                        • Совместимость с международными стандартами
                    `
                }
            },
            "Яндекс Гибрид": {
                name: 'EPSG:3857',
                description: 'Web Mercator (Яндекс.Гибрид)',
                details: {
                    datum: 'WGS 84',
                    proj: '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs',
                    bounds: [-20026376.39, -20048966.10, 20026376.39, 20048966.10],
                    units: 'метры',
                    usage: `
                        <strong>Структура гибридного слоя:</strong><br>
                        • Спутниковые снимки как базовый слой<br>
                        • Векторные данные поверх снимков<br>
                        • Динамические подписи и POI<br><br>
                        <strong>Преимущества:</strong><br>
                        • Комбинированное представление данных<br>
                        • Улучшенная читаемость карты<br>
                        • Актуальная информация об объектах<br><br>
                        <strong>Области применения:</strong><br>
                        • Навигация и логистика<br>
                        • Территориальное планирование<br>
                        • Геомаркетинговые исследования<br><br>
                        <strong>Технические особенности:</strong><br>
                        • Многослойная архитектура<br>
                        • Оптимизированная загрузка данных<br>
                        • Интеллектуальная система масштабирования
                    `
                }
            },
            "Топографическая": {
                name: 'EPSG:3857',
                description: 'Web Mercator (OpenTopoMap)',
                details: {
                    datum: 'WGS 84',
                    proj: '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs',
                    bounds: [-20026376.39, -20048966.10, 20026376.39, 20048966.10],
                    units: 'метры',
                    usage: `
                        <strong>Особенности топографической карты:</strong><br>
                        • Отображение рельефа местности<br>
                        • Горизонтали и отметки высот<br>
                        • Природные и антропогенные объекты<br><br>
                        <strong>Элементы содержания:</strong><br>
                        • Рельеф и гидрография<br>
                        • Растительный покров<br>
                        • Населенные пункты и дороги<br>
                        • Административные границы<br><br>
                        <strong>Применение:</strong><br>
                        • Туристическая навигация<br>
                        • Планирование маршрутов<br>
                        • Анализ рельефа местности<br><br>
                        <strong>Технические характеристики:</strong><br>
                        • Генерализация в зависимости от масштаба<br>
                        • Корректное отображение высот<br>
                        • Поддержка изолиний рельефа
                    `
                }
            }
        };

        let map, baseLayers;

        function initMap() {
            // Создаем карту
            map = L.map('map', {
                crs: mapCrs,
                center: [56.8587, 35.9176], // Центр Твери
                zoom: 10,
                maxZoom: 23,
                zoomControl: true
            });

            // Определяем базовые слои
            baseLayers = {
                "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 23,
                    maxNativeZoom: 19,
                    tileSize: 256,
                    zoomOffset: 0,
                    errorTileUrl: '',
                    attribution: '© OpenStreetMap contributors'
                }),
                "Google Спутник": L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                    maxZoom: 23,
                    maxNativeZoom: 20,
                    tileSize: 256,
                    zoomOffset: 0,
                    errorTileUrl: '',
                    attribution: '© Google'
                }),
                "Google Гибрид": L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                    maxZoom: 23,
                    maxNativeZoom: 20,
                    tileSize: 256,
                    zoomOffset: 0,
                    errorTileUrl: '',
                    attribution: '© Google'
                }),
                "Яндекс": L.tileLayer('https://core-renderer-tiles.maps.yandex.net/tiles?l=map&x={x}&y={y}&z={z}', {
                    maxZoom: 23,
                    maxNativeZoom: 19,
                    tileSize: 256,
                    zoomOffset: 0,
                    errorTileUrl: '',
                    attribution: '© Яндекс'
                }),
                "Яндекс Спутник": L.tileLayer('https://core-sat.maps.yandex.net/tiles?l=sat&x={x}&y={y}&z={z}', {
                    maxZoom: 23,
                    maxNativeZoom: 19,
                    tileSize: 256,
                    zoomOffset: 0,
                    errorTileUrl: '',
                    attribution: '© Яндекс'
                }),
                "Яндекс Гибрид": L.layerGroup([
                    L.tileLayer('https://core-sat.maps.yandex.net/tiles?l=sat&x={x}&y={y}&z={z}', {
                        maxZoom: 23,
                        maxNativeZoom: 19,
                        tileSize: 256,
                        zoomOffset: 0,
                        errorTileUrl: '',
                        attribution: '© Яндекс'
                    }),
                    L.tileLayer('https://core-renderer-tiles.maps.yandex.net/tiles?l=skl&x={x}&y={y}&z={z}', {
                        maxZoom: 23,
                        maxNativeZoom: 19,
                        tileSize: 256,
                        zoomOffset: 0,
                        errorTileUrl: '',
                        attribution: '© Яндекс'
                    })
                ]),
                "Топографическая": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    maxZoom: 23,
                    maxNativeZoom: 17,
                    tileSize: 256,
                    zoomOffset: 0,
                    errorTileUrl: '',
                    attribution: '© OpenTopoMap'
                })
            };

            // Добавляем основной слой
            baseLayers["OpenStreetMap"].addTo(map);

            // Добавляем масштаб
            L.control.scale({
                imperial: false,
                metric: true
            }).addTo(map);

            // Обновим контрол информации о CRS
            const crsInfoControl = L.control({position: 'bottomleft'});
            crsInfoControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'leaflet-control-layers crs-info');
                div.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
                div.style.padding = '3px 5px';
                div.style.borderRadius = '3px';
                div.style.fontSize = '10px';
                div.style.maxWidth = '150px';
                div.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                div.style.cursor = 'pointer';
                div.style.color = '#666';

                // Предотвращаем события карты при взаимодействии с контролом
                L.DomEvent.disableClickPropagation(div);
                L.DomEvent.disableScrollPropagation(div);

                // Создаем всплывающее окно
                const popup = L.popup({
                    className: 'crs-popup',
                    closeButton: true,
                    closeOnClick: true,
                    autoClose: true,
                    offset: [0, -5]
                });

                function updateCrsInfo() {
                    let activeLayer = 'OpenStreetMap';
                    Object.entries(baseLayers).forEach(([name, layer]) => {
                        if (map.hasLayer(layer)) activeLayer = name;
                    });
                    div.innerHTML = `${layersCrsInfo[activeLayer].name}`;

                    // Обновляем обработчик клика
                    div.onclick = function(e) {
                        e.stopPropagation();
                        const info = layersCrsInfo[activeLayer];
                        const content = `
                            <div style="font-size: 12px; max-width: 400px; max-height: 400px; overflow-y: auto;">
                                <strong>${info.name}</strong><br>
                                ${info.description}<br><br>
                                <strong>Базовые параметры:</strong><br>
                                <small>
                                    • Датум: ${info.details.datum}<br>
                                    • Единицы: ${info.details.units}<br>
                                    • Proj4: <span style="font-size: 10px; word-break: break-all;">${info.details.proj}</span>
                                </small><br><br>
                                <div style="font-size: 11px;">
                                    ${info.details.usage}
                                </div>
                            </div>
                        `;

                        // Позиционируем попап над контролом
                        const controlPoint = map.containerPointToLatLng([
                            div.getBoundingClientRect().left + div.offsetWidth/2,
                            div.getBoundingClientRect().top
                        ]);
                        
                        popup.setContent(content)
                            .setLatLng(controlPoint)
                            .openOn(map);
                    };
                }

                updateCrsInfo();
                map.on('baselayerchange', updateCrsInfo);
                return div;
            };
            crsInfoControl.addTo(map);

            // Создадим новый контрол для поиска
            const SearchControl = L.Control.extend({
                options: {
                    position: 'topright'
                },

                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'leaflet-control search-control');
                    
                    // Создаем кнопку с иконкой поиска
                    const button = L.DomUtil.create('button', 'search-button', container);
                    button.innerHTML = '🔍';
                    
                    // Создаем контейнер для поиска
                    const searchContainer = L.DomUtil.create('div', 'search-container', container);
                    const searchInput = L.DomUtil.create('input', 'search-input', searchContainer);
                    searchInput.type = 'text';
                    searchInput.placeholder = 'Поиск по адресу...';
                    const searchResults = L.DomUtil.create('div', 'search-results', searchContainer);

                    let searchTimeout;
                    let searchMarker;

                    // Предотвращаем события карты
                    L.DomEvent.disableClickPropagation(container);
                    L.DomEvent.disableScrollPropagation(container);

                    // Обработчик клика по кнопке поиска
                    button.onclick = function(e) {
                        e.preventDefault();
                        if (searchContainer.style.display === 'none') {
                            searchContainer.style.display = 'block';
                            setTimeout(() => {
                                searchContainer.classList.add('active');
                                searchInput.focus();
                            }, 10);
                        } else {
                            searchContainer.classList.remove('active');
                            setTimeout(() => {
                                searchContainer.style.display = 'none';
                            }, 300);
                        }
                    };

                    // Обработчик ввода в поле поиска
                    searchInput.addEventListener('input', function() {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(() => {
                            const query = this.value;
                            if (query.length >= 3) {
                                // Используем Nominatim для поиска
                                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=ru&limit=10`)
                                    .then(response => response.json())
                                    .then(data => {
                                        searchResults.innerHTML = '';
                                        data.forEach(result => {
                                            const resultItem = L.DomUtil.create('div', 'search-result-item', searchResults);
                                            resultItem.textContent = result.display_name;
                                            resultItem.onclick = () => {
                                                if (searchMarker) {
                                                    map.removeLayer(searchMarker);
                                                }
                                                const lat = parseFloat(result.lat);
                                                const lon = parseFloat(result.lon);
                                                searchMarker = L.marker([lat, lon]).addTo(map);
                                                map.setView([lat, lon], 16);
                                                searchMarker.bindPopup(result.display_name).openPopup();
                                                searchContainer.classList.remove('active');
                                                searchInput.value = result.display_name;
                                            };
                                        });
                                    })
                                    .catch(console.error);
                            }
                        }, 300);
                    });

                    // Закрываем поиск при клике вне его
                    document.addEventListener('click', function(e) {
                        if (!container.contains(e.target)) {
                            searchContainer.classList.remove('active');
                            setTimeout(() => {
                                searchContainer.style.display = 'none';
                            }, 300);
                        }
                    });

                    return container;
                }
            });

            // В функции initMap добавляем:
            map.addControl(new SearchControl());

            // Добавляем слои для кадастровых объектов
            let cadastralLayers = {
                "Земельные участки": L.layerGroup().addTo(map),
                "Объекты капитального строительства": L.layerGroup().addTo(map),
                "Кадастровые объекты": L.layerGroup().addTo(map)
            };
            
            // Добавляем слой для рисования полигонов поиска
            let drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            // Настраиваем контрол для рисования
            let drawControl = new L.Control.Draw({
                draw: {
                    polyline: false,
                    rectangle: true,
                    circle: false,
                    circlemarker: false,
                    marker: false,
                    polygon: {
                        allowIntersection: false,
                        drawError: {
                            color: '#e1e100',
                            message: '<strong>Ошибка:</strong> полигоны не могут пересекаться!'
                        },
                        shapeOptions: {
                            color: '#0078A8',
                            weight: 2
                        }
                    }
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            
            // Обработка событий рисования
            map.on(L.Draw.Event.CREATED, function (event) {
                const layer = event.layer;
                drawnItems.addLayer(layer);
                
                // Если это полигон или прямоугольник, запрашиваем объекты в этой области
                if (event.layerType === 'polygon' || event.layerType === 'rectangle') {
                    searchObjectsInArea(layer);
                }
            });
            
            // Функция для поиска объектов в выделенной области
            function searchObjectsInArea(layer) {
                // Показываем индикатор загрузки
                document.querySelector('.loading-indicator').style.display = 'block';
                
                // Получаем координаты полигона
                const polygon = layer.toGeoJSON();
                
                // Добавляем отладочную информацию в консоль
                console.log('Отправляем запрос с геометрией:', JSON.stringify(polygon.geometry));
                
                // Отправляем запрос на сервер
                fetch('/api/cadastral/search_in_contour', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        geometry: polygon.geometry
                    })
                })
                .then(response => {
                    // Проверяем статус ответа
                    if (!response.ok) {
                        // Пытаемся получить детали ошибки из ответа
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || `Ошибка сервера: ${response.status}`);
                        }).catch(err => {
                            // Если не удалось распарсить JSON с ошибкой
                            if (err instanceof SyntaxError) {
                                throw new Error(`Ошибка сервера: ${response.status}`);
                            }
                            throw err;
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Скрываем индикатор загрузки
                    document.querySelector('.loading-indicator').style.display = 'none';
                    
                    if (data.features && data.features.length > 0) {
                        // Добавляем найденные объекты на карту
                        data.features.forEach(feature => {
                            // Определяем тип объекта (ЗУ или ОКС)
                            const isLandParcel = feature.properties.land_record_type === 'Земельный участок';
                            addCadastralObject({
                                type: 'Feature',
                                properties: feature.properties,
                                geometry: feature.geometry,
                                objectType: isLandParcel ? 'Земельный участок' : 'Объект капитального строительства'
                            }, isLandParcel);
                        });
                        
                        // Отображаем сообщение с количеством найденных объектов
                        alert(`Найдено объектов: ${data.features.length}`);
                    } else {
                        alert('В выбранной области не найдено кадастровых объектов');
                    }
                })
                .catch(error => {
                    // Скрываем индикатор загрузки
                    document.querySelector('.loading-indicator').style.display = 'none';
                    
                    console.error('Ошибка при поиске объектов:', error);
                    
                    // Проверяем конкретные ошибки
                    if (error.message.includes('TooBigContour')) {
                        alert('Выбранная область слишком большая. Пожалуйста, выберите меньшую область.');
                    } else {
                        // Показываем подробное сообщение об ошибке
                        alert(`Ошибка при поиске объектов: ${error.message}`);
                    }
                });
            }
            
            // Добавляем обработчики для кнопок работы с контурами
            document.getElementById('draw-polygon-btn').addEventListener('click', function() {
                // Активируем инструмент рисования полигона
                new L.Draw.Polygon(map, drawControl.options.draw.polygon).enable();
            });
            
            document.getElementById('clear-polygon-btn').addEventListener('click', function() {
                // Очищаем все нарисованные полигоны
                drawnItems.clearLayers();
            });

            // Добавляем ТОЛЬКО БАЗОВЫЕ слои в контрол (удаляем кадастровые из основного контрола)
            // Удаляем дублирующий контрол слоев, который находился в красном квадрате на скриншоте
            L.control.layers(baseLayers, null, {
                position: 'topright',
                collapsed: true
            }).addTo(map);

            // Создаем отдельный контрол для кадастровых слоев
            const cadastralLayersControl = L.Control.extend({
                options: {
                    position: 'topright'
                },

                onAdd: function() {
                    const container = L.DomUtil.create('div', 'cadastral-layers-control');
                    container.innerHTML = `
                        <div class="cadastral-layers-title">Кадастровые слои</div>
                        <div class="cadastral-layer-items">
                            <div class="cadastral-layer-item">
                                <input type="checkbox" id="layer-land-parcels" checked>
                                <label for="layer-land-parcels">Земельные участки</label>
                            </div>
                            <div class="cadastral-layer-item">
                                <input type="checkbox" id="layer-buildings" checked>
                                <label for="layer-buildings">Объекты капитального строительства</label>
                            </div>
                            <div class="cadastral-layer-item">
                                <input type="checkbox" id="layer-cadastral-all" checked>
                                <label for="layer-cadastral-all">Кадастровые объекты</label>
                            </div>
                        </div>
                    `;

                    // Предотвращаем перехват событий картой
                    L.DomEvent.disableClickPropagation(container);
                    L.DomEvent.disableScrollPropagation(container);

                    // Добавляем обработчики для чекбоксов
                    const landParcelsCheckbox = container.querySelector('#layer-land-parcels');
                    const buildingsCheckbox = container.querySelector('#layer-buildings');
                    const cadastralAllCheckbox = container.querySelector('#layer-cadastral-all');

                    landParcelsCheckbox.addEventListener('change', function() {
                        if (this.checked) {
                            map.addLayer(cadastralLayers["Земельные участки"]);
                        } else {
                            map.removeLayer(cadastralLayers["Земельные участки"]);
                        }
                    });

                    buildingsCheckbox.addEventListener('change', function() {
                        if (this.checked) {
                            map.addLayer(cadastralLayers["Объекты капитального строительства"]);
                        } else {
                            map.removeLayer(cadastralLayers["Объекты капитального строительства"]);
                        }
                    });

                    cadastralAllCheckbox.addEventListener('change', function() {
                        if (this.checked) {
                            map.addLayer(cadastralLayers["Кадастровые объекты"]);
                        } else {
                            map.removeLayer(cadastralLayers["Кадастровые объекты"]);
                        }
                    });

                    // Делаем контейнер перетаскиваемым
                    this._makeControlDraggable(container);

                    return container;
                },

                // Функция для создания перетаскиваемого элемента
                _makeControlDraggable: function(container) {
                    // Создаем кнопку восстановления
                    const recoverButton = document.createElement('button');
                    recoverButton.textContent = 'Восстановить панель слоев';
                    recoverButton.style.position = 'fixed';
                    recoverButton.style.bottom = '10px';
                    recoverButton.style.right = '10px';
                    recoverButton.style.padding = '8px 12px';
                    recoverButton.style.backgroundColor = '#0078A8';
                    recoverButton.style.color = 'white';
                    recoverButton.style.border = 'none';
                    recoverButton.style.borderRadius = '4px';
                    recoverButton.style.zIndex = '2000';
                    recoverButton.style.cursor = 'pointer';
                    recoverButton.style.fontSize = '12px';
                    recoverButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.3)';
                    document.body.appendChild(recoverButton);
                    
                    // Явно устанавливаем начальное положение (чтобы оно было правильным до применения localStorage)
                    $(container).css({
                        top: '10px',
                        right: '50px',
                        left: 'auto'
                    });
                    
                    // Функция сброса позиции
                    function resetPosition() {
                        $(container).css({
                            top: '10px',
                            right: '50px',
                            left: 'auto'
                        });
                        
                        // Сохраняем позицию
                        try {
                            localStorage.setItem('cadastralLayersPosition', JSON.stringify({
                                top: 10,
                                right: 50,
                                left: null
                            }));
                        } catch (e) {
                            console.error('Ошибка сохранения позиции:', e);
                        }
                    }
                    
                    // Загрузка сохраненной позиции
                    function loadPosition() {
                        try {
                            // Пытаемся получить сохраненную позицию
                            const positionStr = localStorage.getItem('cadastralLayersPosition');
                            
                            // Если нет сохраненной позиции или она некорректная, используем позицию по умолчанию
                            if (!positionStr) {
                                resetPosition();
                                return;
                            }
                            
                            const position = JSON.parse(positionStr);
                            
                            // Проверяем валидность сохраненной позиции
                            if (!position || typeof position !== 'object') {
                                resetPosition();
                                return;
                            }
                            
                            // Безопасная установка позиции
                            if (position.right !== null) {
                                $(container).css({
                                    right: position.right + 'px',
                                    left: 'auto'
                                });
                            } else if (position.left !== null) {
                                $(container).css({
                                    left: position.left + 'px',
                                    right: 'auto'
                                });
                            }
                            
                            if (position.top !== null) {
                                $(container).css('top', position.top + 'px');
                            }
                            
                            // Проверка, что панель находится в видимой области экрана
                            setTimeout(function() {
                                const rect = container.getBoundingClientRect();
                                const viewportWidth = window.innerWidth;
                                const viewportHeight = window.innerHeight;
                                
                                // Если панель ушла за пределы экрана, сбрасываем позицию
                                if (rect.left > viewportWidth - 50 || 
                                    rect.right < 50 || 
                                    rect.top > viewportHeight - 50 || 
                                    rect.bottom < 0) {
                                    resetPosition();
                                }
                            }, 100);
                        } catch (e) {
                            console.error('Ошибка загрузки позиции:', e);
                            resetPosition();
                        }
                    }
                    
                    // Очищаем localStorage при первом запуске (только для отладки)
                    // localStorage.removeItem('cadastralLayersPosition');
                    
                    // Заголовок панели
                    const title = container.querySelector('.cadastral-layers-title');
                    
                    // Инициализируем перетаскивание с помощью jQuery UI
                    $(container).draggable({
                        handle: '.cadastral-layers-title',  // Перетаскивание только за заголовок
                        addClasses: false,                  // Не добавлять классы jQuery UI
                        scroll: false,                      // Отключить автоскроллинг
                        containment: [
                            -$(container).width() + 50,     // Минимальная левая позиция (50px видны)
                            0,                              // Минимальная верхняя позиция
                            $(window).width() - 50,         // Максимальная правая позиция
                            $(window).height() - 50         // Максимальная нижняя позиция
                        ],
                        start: function() {
                            $(container).addClass('dragging');
                            
                            // Если панель позиционирована справа, преобразуем в левое позиционирование
                            if ($(container).css('right') !== 'auto') {
                                const rect = container.getBoundingClientRect();
                                $(container).css({
                                    left: rect.left + 'px',
                                    right: 'auto'
                                });
                            }
                        },
                        stop: function() {
                            $(container).removeClass('dragging');
                            
                            // Сохраняем позицию
                            try {
                                const rect = container.getBoundingClientRect();
                                localStorage.setItem('cadastralLayersPosition', JSON.stringify({
                                    top: rect.top,
                                    right: null,
                                    left: rect.left
                                }));
                            } catch (e) {
                                console.error('Ошибка сохранения позиции:', e);
                            }
                        }
                    });
                    
                    // Двойной клик по заголовку для сброса позиции
                    $(title).dblclick(function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        resetPosition();
                    });
                    
                    // Кнопка восстановления
                    $(recoverButton).click(resetPosition);
                    
                    // Проверка видимости при изменении размера окна
                    $(window).resize(function() {
                        const rect = container.getBoundingClientRect();
                        const viewportWidth = window.innerWidth;
                        const viewportHeight = window.innerHeight;
                        
                        // Обновляем containment для draggable
                        $(container).draggable('option', 'containment', [
                            -$(container).width() + 50,
                            0,
                            viewportWidth - 50,
                            viewportHeight - 50
                        ]);
                        
                        // Если панель ушла за пределы экрана
                        if (rect.left > viewportWidth || 
                            rect.right < 0 || 
                            rect.top > viewportHeight || 
                            rect.bottom < 0) {
                            resetPosition();
                        }
                    });
                    
                    // Загружаем сохраненную позицию после всех настроек
                    loadPosition();
                }
            });

            // Добавляем наш кастомный контрол для кадастровых слоев
            map.addControl(new cadastralLayersControl());

            // Обеспечиваем корректный размер карты
                map.invalidateSize();
            
            // Слушаем события изменения размера окна
            window.addEventListener('resize', function() {
                map.invalidateSize();
            });

            // Инициализируем переменные для работы с кадастровыми объектами
            let cadastralFeatures = {};

            // Функция для поиска кадастрового объекта
            document.getElementById('cadastral-search-btn').addEventListener('click', searchCadastralObject);
            document.getElementById('cadastral-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchCadastralObject();
                }
            });

            // Функция для поиска кадастрового объекта
            function searchCadastralObject() {
                const cadastralNumber = document.getElementById('cadastral-input').value.trim();
                if (!cadastralNumber) {
                    alert('Введите кадастровый номер');
                    return;
                }

                fetch(`/api/cadastral?cadastral_number=${encodeURIComponent(cadastralNumber)}`)
                    .then(response => {
                        if (!response.ok) {
                            if (response.status === 404) {
                                throw new Error('Объект не найден');
                            }
                            throw new Error('Ошибка при получении данных');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Если объект уже добавлен, центрируемся на нем
                        if (cadastralFeatures[cadastralNumber]) {
                            // Найдем слой с этим объектом
                            let foundLayer;
                            for (let layerName in cadastralLayers) {
                                cadastralLayers[layerName].eachLayer(layer => {
                                    if (layer.feature && layer.feature.properties.cad_num === cadastralNumber) {
                                        foundLayer = layer;
                                    }
                                });
                            }
                            
                            if (foundLayer) {
                                map.fitBounds(foundLayer.getBounds());
                                foundLayer.openPopup();
                                return;
                            }
                        }

                        // Определяем тип объекта по семантике и данным API
                        let isLandParcel;
                        
                        // Проверяем данные с API
                        if (data.objectType === 'Земельный участок') {
                            isLandParcel = true;
                        } else if (data.objectType === 'Объект капитального строительства') {
                            isLandParcel = false;
            } else {
                            // Если API не дал точного ответа, определяем по кадастровому номеру
                            // Земельные участки обычно имеют формат XX:XX:XXXXXX:XX
                            // ОКС имеют формат XX:XX:XXXXXX:XX:XX или содержат буквы (здание, сооружение и т.д.)
                            const parts = cadastralNumber.split(':');
                            if (parts.length <= 4 && !cadastralNumber.match(/[а-яА-Я]/)) {
                                isLandParcel = true;
                            } else {
                                isLandParcel = false;
                            }
                        }
                        
                        // Добавляем объект на карту
                        addCadastralObject(data, isLandParcel);
                    })
                    .catch(error => {
                        alert(`Ошибка: ${error.message}`);
                    });
            }

            // Функция для добавления кадастрового объекта на карту
            function addCadastralObject(data, isLandParcel) {
                // Определяем слой для добавления
                const layerName = isLandParcel ? "Земельные участки" : "Объекты капитального строительства";
                
                // Определяем стиль в зависимости от типа объекта
                const style = {
                    color: isLandParcel ? '#000000' : '#8B4513', // Черный для ЗУ, коричневый для ОКС
                    weight: 1.5,
                    opacity: 1, // Делаем контуры полностью видимыми
                    fillOpacity: 0, // Полностью убираем заливку объектов
                    fillColor: isLandParcel ? '#000000' : '#8B4513', // Черная/коричневая заливка
                    dashArray: null,
                    lineCap: 'round',
                    lineJoin: 'round'
                };

                // Добавляем информацию о типе объекта в свойства
                if (!data.properties) data.properties = {};
                data.properties.isLandParcel = isLandParcel;

                // Создаем функцию для генерации содержимого popup
                function generatePopupContent(feature) {
                    let content = `<div class="cadastral-popup-content">`;
                    content += `<div class="cadastral-popup-title">${feature.properties.cad_num || 'Нет данных'}</div>`;
                    
                    // Добавляем основные свойства объекта
                    const fields = [
                        { key: 'readable_address', label: 'Адрес' },
                        { key: 'specified_area', label: 'Площадь уточненная' },
                        { key: 'declared_area', label: 'Площадь декларированная' },
                        { key: 'cost_value', label: 'Кадастровая стоимость' },
                        { key: 'land_record_type', label: 'Тип объекта' },
                        { key: 'status', label: 'Статус' },
                        { key: 'category_type', label: 'Категория земель' },
                        { key: 'rights_reg', label: 'Права зарегистрированы' }
                    ];
                    
                    fields.forEach(field => {
                        if (feature.properties[field.key]) {
                            let value = feature.properties[field.key];
                            if (field.key === 'specified_area' || field.key === 'declared_area') {
                                value += ' кв.м';
                            } else if (field.key === 'cost_value') {
                                value += ' руб.';
                            }
                            
                            content += `
                                <div class="cadastral-popup-row">
                                    <div class="cadastral-popup-label">${field.label}:</div>
                                    <div class="cadastral-popup-value">${value}</div>
                                </div>
                            `;
                        }
                    });
                    
                    content += '</div>';
                    return content;
                }

                // Отключаем стандартные обработчики событий Leaflet для наших слоев
                const geoJsonOptions = {
                    style: style,
                    interactive: true,
                    bubblingMouseEvents: false,  // Предотвращаем всплытие событий мыши
                    onEachFeature: function(feature, layer) {
                        // Добавляем tooltip
                        layer.bindTooltip(`Кадастровый номер: ${feature.properties.cad_num || 'Нет данных'}`, {
                            className: 'cadastral-tooltip',
                            direction: 'top',
                            permanent: false
                        });
                        
                        // Создаем и добавляем popup
                        const popupContent = generatePopupContent(feature);
                        layer.bindPopup(popupContent, {
                            className: 'cadastral-popup',
                            maxWidth: 350
                        });
                        
                        // Добавляем подпись с номером участка (последняя часть кадастрового номера)
                        if (feature.properties.cad_num) {
                            const cadNumParts = feature.properties.cad_num.split(':');
                            const lastPart = ":" + cadNumParts[cadNumParts.length - 1];
                            
                            // Получаем центр объекта для размещения метки
                            const bounds = layer.getBounds();
                            const center = bounds.getCenter();
                            
                            // Создаем иконку с текстом
                            const labelIcon = L.divIcon({
                                html: lastPart,
                                className: 'cadastral-label',
                                iconSize: null  // Автоматический размер
                            });
                            
                            // Добавляем маркер с меткой на центр объекта
                            L.marker(center, { 
                                icon: labelIcon,
                                interactive: false,  // Делаем метку неинтерактивной
                                zIndexOffset: 1000   // Поднимаем метку над полигоном
                            }).addTo(cadastralLayers[layerName]);
                        }
                        
                        // Сохраняем кадастровый номер в feature
                        cadastralFeatures[feature.properties.cad_num] = feature;
                    }
                };
                
                // Создаем GeoJSON слой для основного слоя
                const layer = L.geoJSON(data, geoJsonOptions);
                
                // Добавляем слой на карту в соответствующую категорию
                cadastralLayers[layerName].addLayer(layer);
                
                // Дублируем объект на общий слой кадастровых объектов
                // Используем тот же стиль и функции событий
                cadastralLayers["Кадастровые объекты"].addLayer(
                    L.geoJSON(data, geoJsonOptions)
                );
                
                // Более плавное центрирование карты с отступами
                map.fitBounds(layer.getBounds(), {
                    padding: [50, 50],
                    maxZoom: 18,
                    animate: true,
                    duration: 0.5
                });
                
                // Открываем popup с небольшой задержкой
                setTimeout(() => {
                    layer.eachLayer(l => l.openPopup());
                }, 500);
            }
        }

        // Инициализируем карту после загрузки страницы
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html> 